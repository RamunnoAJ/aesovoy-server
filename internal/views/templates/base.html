<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Eso Voy</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal flex flex-col min-h-screen">
    {{if .User}}
    <nav class="bg-blue-600 p-4 text-white z-10 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="/" class="font-bold text-xl">A Eso Voy</a>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div class="font-bold">{{.User.Username}}</div>
                    <div class="text-xs uppercase opacity-75">{{.User.Role}}</div>
                </div>
                <button hx-post="/logout" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">
                    Salir
                </button>
            </div>
        </div>
    </nav>
    {{end}}

    <div class="flex flex-1">
        {{if .User}}
        <aside class="w-64 bg-gray-800 text-white flex-shrink-0 hidden md:block">
            <div class="p-4">
                <h2 class="text-xs uppercase text-gray-400 font-semibold mb-4">Menu</h2>
                <nav class="space-y-2">
                    <a href="/" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Dashboard
                    </a>
                    <a href="/products" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Productos
                    </a>
                    
                    {{if eq .User.Role "administrator"}}
                    <a href="/categories" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Categorías
                    </a>
                    <a href="/ingredients" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Ingredientes
                    </a>
                    <a href="/providers" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Proveedores
                    </a>
                    <a href="/clients" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Clientes
                    </a>
                    {{end}}

                    <a href="/payment_methods" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Métodos de Pago
                    </a>
                    
                    {{if eq .User.Role "administrator"}}
                    <a href="/orders" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Órdenes
                    </a>
                    <a href="/invoices" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Facturas
                    </a>
                    {{end}}
                        
                    {{if or (eq .User.Role "administrator") (eq .User.Role "employee")}}
                    <a href="/local-sales" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Ventas Local
                    </a>
                    {{end}}
                        
                    {{if eq .User.Role "administrator"}}
                    <a href="/users" class="block py-2 px-4 rounded hover:bg-gray-700 transition-colors">
                        Usuarios
                    </a>
                    {{end}}
                </nav>
            </div>
        </aside>
        {{end}}

        <main class="flex-1 p-6 overflow-y-auto">
            {{block "content" .}}{{end}}
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" id="modal-title">Confirmar Acción</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message">
                        ¿Estás seguro?
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Confirmar
                    </button>
                    <button id="modal-cancel" class="mt-3 px-4 py-2 bg-white text-gray-700 text-base font-medium rounded-md w-full shadow-sm border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CSRF Token for HTMX
        document.body.addEventListener('htmx:configRequest', function(evt) {
            const cookies = document.cookie.split(';');
            let csrfToken = null;
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrf_token') {
                    csrfToken = value;
                    break;
                }
            }
            if (csrfToken) {
                evt.detail.headers['X-CSRF-Token'] = csrfToken;
            }
        });

        // Confirmation Modal Logic
        document.addEventListener("htmx:confirm", function(evt) {
            // If the event was not triggered by hx-confirm, or if standard confirm wasn't requested
            if (!evt.detail.question) return;

            // Prevent the default confirmation
            evt.preventDefault();

            const modal = document.getElementById('confirmation-modal');
            const message = document.getElementById('modal-message');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            message.textContent = evt.detail.question;
            modal.classList.remove('hidden');

            const handleConfirm = function() {
                evt.detail.issueRequest(true); // issueRequest(true) skips the confirm check
                cleanup();
            };

            const handleCancel = function() {
                cleanup();
            };
            
            const cleanup = function() {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            }

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        });

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                'error': 'bg-red-500',
                'success': 'bg-green-500',
                'info': 'bg-blue-500'
            };
            const color = colors[type] || colors['info'];

            toast.className = `${color} text-white px-6 py-4 rounded shadow-lg transition-all duration-300 opacity-0 transform translate-y-2`;
            toast.textContent = message;

            container.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
            });

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        document.body.addEventListener("showToast", function(evt){
            showToast(evt.detail.message, evt.detail.type);
        });

        // Check URL parameters for messages
        const urlParams = new URLSearchParams(window.location.search);
        const errorMsg = urlParams.get('error');
        const successMsg = urlParams.get('success');

        if (errorMsg) {
            showToast(errorMsg, 'error');
            // Clean URL
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
        if (successMsg) {
            showToast(successMsg, 'success');
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }

        // HTMX Error Handling
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.failed) {
                const xhr = evt.detail.xhr;
                let msg = "Ha ocurrido un error inesperado";
                try {
                    const resp = JSON.parse(xhr.responseText);
                    if (resp.message) {
                        msg = resp.message;
                    } else if (resp.error && typeof resp.error === 'string') {
                        msg = resp.error;
                    }
                } catch (e) {
                    if (xhr.responseText && xhr.responseText.length < 200) {
                        msg = xhr.responseText;
                    }
                }
                showToast(msg, 'error');
            }
        });

        // Reusable Alpine.js function for product item management with search
        function createProductItemManager(allProductsData, pricingFunction) {
            // Create a lookup map for quick access
            const productsLookup = allProductsData.reduce((acc, p) => {
                acc[p.id] = p;
                return acc;
            }, {});

            return {
                items: [{ product_id: '', quantity: 1, searchTerm: '', isOpen: false }],
                
                getFilteredProducts(index) {
                    const term = this.items[index].searchTerm;
                    if (!term) {
                        return allProductsData;
                    }
                    const lowerSearchTerm = term.toLowerCase();
                    return allProductsData.filter(p => p.name.toLowerCase().includes(lowerSearchTerm));
                },

                selectProduct(index, product) {
                    // Check for duplicates
                    const isDuplicate = this.items.some((item, i) => i !== index && item.product_id === product.id);
                    if (isDuplicate) {
                        showToast('Este producto ya ha sido agregado.', 'error');
                        this.items[index].isOpen = false;
                        return;
                    }

                    this.items[index].product_id = product.id;
                    this.items[index].searchTerm = product.name;
                    this.items[index].isOpen = false;
                },

                openDropdown(index) {
                    this.items[index].isOpen = true;
                },

                closeDropdown(index) {
                    // Delay closing to allow click event on option to fire
                    setTimeout(() => {
                        this.items[index].isOpen = false;
                    }, 200);
                },

                addItem() {
                    this.items.push({ product_id: '', quantity: 1, searchTerm: '', isOpen: false });
                },
                
                removeItem(index) {
                    if (this.items.length > 1) { // Ensure at least one item remains
                        this.items.splice(index, 1);
                    }
                },

                getPrice(productId, priceType = 'unit') {
                    if (!productId || !productsLookup[productId]) return '';
                    return pricingFunction(productsLookup[productId], priceType);
                },

                getSubtotal(index, priceType = 'unit') {
                    const item = this.items[index];
                    const price = parseFloat(this.getPrice(item.product_id, priceType));
                    if (!isNaN(price) && item.quantity) {
                        return (price * item.quantity).toFixed(2);
                    }
                    return '0.00';
                },

                getTotal(priceType = 'unit') {
                    let total = 0;
                    this.items.forEach((item, index) => {
                        const sub = parseFloat(this.getSubtotal(index, priceType));
                        if (!isNaN(sub)) {
                            total += sub;
                        }
                    });
                    return total.toFixed(2);
                }
            }
        }
    </script>
</body>
</html>

{{define "content"}}
<div class="bg-white rounded-lg shadow-lg" x-data="userManagement()">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Usuarios</h1>
        <div class="flex items-center gap-4">
            <button @click="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Nuevo Usuario
            </button>
        </div>
    </div>
    
    <div class="overflow-x-auto md:overflow-visible">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                    <th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                    <th scope="col" class="px-6 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    <th scope="col" class="px-6 py-3 text-right text-sm font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {{range .Users}}
                    {{template "user_row.html" .}}
                {{end}}
            </tbody>
        </table>
    </div>

    <!-- Create User Modal -->
    <div x-show="showModal" 
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center"
         style="display: none;">
        <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Nuevo Usuario</h3>
                <form @submit.prevent="createUser">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Usuario</label>
                            <input type="text" x-model="newUser.username" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" x-model="newUser.email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                            <input type="password" x-model="newUser.password" required minlength="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Rol</label>
                            <select x-model="newUser.role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="employee">Empleado</option>
                                <option value="administrator">Administrador</option>
                            </select>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3 mt-4">
                        <button type="button" @click="closeModal()" class="mt-3 px-4 py-2 bg-white text-gray-700 text-base font-medium rounded-md w-full shadow-sm border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancelar
                        </button>
						<button type="submit" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300">
							Crear
						</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function userManagement() {
        return {
            showModal: false,
            newUser: {
                username: '',
                email: '',
                password: '',
                role: 'employee'
            },
            openModal() {
                this.showModal = true;
                this.newUser = { username: '', email: '', password: '', role: 'employee' };
            },
            closeModal() {
                this.showModal = false;
            },
            getCsrfToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrf_token') {
                        return value;
                    }
                }
                return '';
            },
            async createUser() {
                try {
                    const response = await fetch('/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': this.getCsrfToken()
                        },
                        body: JSON.stringify(this.newUser)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Error al crear usuario');
                    }

                    // Dispatch toast event
                    const event = new CustomEvent('showToast', {
                        detail: { message: 'Usuario creado exitosamente', type: 'success' }
                    });
                    document.body.dispatchEvent(event);

                    this.closeModal();
                    // Reload to show new user
                    setTimeout(() => window.location.reload(), 1000);

                } catch (error) {
                    const event = new CustomEvent('showToast', {
                        detail: { message: error.message, type: 'error' }
                    });
                    document.body.dispatchEvent(event);
                }
            }
        }
    }
</script>
{{end}}

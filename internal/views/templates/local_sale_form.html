{{define "content"}}
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
    <div class="p-6 border-b border-gray-200">
        <h1 class="text-2xl font-bold text-gray-800">Nueva Venta Local</h1>
    </div>
    
    <form action="/local-sales/new" method="POST" class="p-6 space-y-6" x-data="localSaleForm()">
        
        <!-- Payment Method Selection -->
        <div>
            <label for="payment_method_id" class="block text-base font-medium leading-6 text-gray-900">MÃ©todo de Pago</label>
            <div class="mt-2">
                <select id="payment_method_id" name="payment_method_id" required class="block w-full rounded-md border-0 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 text-base sm:leading-6 px-3">
                    <option value="">Seleccionar...</option>
                    {{range .PaymentMethods}}
                    <option value="{{.ID}}">{{.Name}}</option>
                    {{end}}
                </select>
            </div>
        </div>

        <!-- Items List -->
        <div class="border-t border-gray-200 pt-4">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Productos</h3>
            
            <template x-for="(item, index) in items" :key="index">
                <div class="grid grid-cols-12 gap-4 mb-4 items-end">
                    <div class="col-span-5">
                        <label :for="'product_' + index" class="block text-sm font-medium text-gray-700" x-show="index === 0">Producto</label>
                        <select :name="'product_ids[]'" x-model="item.product_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base">
                            <option value="">Seleccionar...</option>
                            {{range .Products}}
                            <option value="{{.ID}}">{{.Name}} (${{.UnitPrice}})</option>
                            {{end}}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label :for="'quantity_' + index" class="block text-sm font-medium text-gray-700" x-show="index === 0">Cant.</label>
                        <input type="number" :name="'quantities[]'" x-model="item.quantity" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base">
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-gray-700" x-show="index === 0">Subtotal ($)</label>
                        <input type="text" :value="getSubtotal(index)" readonly tabindex="-1" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base text-gray-900 font-medium cursor-default">
                    </div>
                    <div class="col-span-2">
                        <button type="button" @click="removeItem(index)" class="w-full bg-red-100 text-red-700 hover:bg-red-200 font-medium py-2 px-4 rounded text-sm mt-1" x-show="items.length > 1">
                            Quitar
                        </button>
                    </div>
                </div>
            </template>

            <button type="button" @click="addItem()" class="mt-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded text-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Agregar Producto
            </button>
        </div>

        <div class="flex items-center justify-end gap-x-6 border-t pt-4">
            <div class="mr-auto text-lg font-bold text-gray-900">Total: $<span x-text="getTotal()"></span></div>
            <a href="/local-sales" class="text-base font-semibold leading-6 text-gray-900">Cancelar</a>
            <button type="submit" class="rounded-md bg-blue-600 px-3 py-2 text-base font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">Registrar Venta</button>
        </div>
    </form>
</div>

<script>
    function localSaleForm() {
        const products = {
            {{range .Products}}
            "{{.ID}}": {{.UnitPrice}},
            {{end}}
        };

        return {
            items: [{ product_id: '', quantity: 1 }],
            
            addItem() {
                this.items.push({ product_id: '', quantity: 1 });
            },
            
            removeItem(index) {
                this.items.splice(index, 1);
            },

            getPrice(productId) {
                if (!productId || !products[productId]) return 0;
                return products[productId];
            },

            getSubtotal(index) {
                const item = this.items[index];
                const price = this.getPrice(item.product_id);
                if (price && item.quantity) {
                    return (price * item.quantity).toFixed(2);
                }
                return '0.00';
            },

            getTotal() {
                let total = 0;
                this.items.forEach((item, index) => {
                    const sub = parseFloat(this.getSubtotal(index));
                    if (!isNaN(sub)) {
                        total += sub;
                    }
                });
                return total.toFixed(2);
            }
        }
    }
</script>
<!-- Alpine.js -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{{end}}
